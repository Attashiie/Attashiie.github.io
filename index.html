<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisador de Desmatamento com I.A.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .canvas-container {
      position: relative;
      width: 100%;
      padding-top: 100%;
      background-color: #e5e7eb;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }
    .placeholder-icon {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: #9ca3af;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
  <header class="text-center mb-8">
    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Analisador de Desmatamento com I.A.</h1>
    <p class="mt-2 text-md sm:text-lg text-gray-600">APS - Processamento de Imagens e Visão Computacional</p>
  </header>

  <main class="bg-white rounded-xl shadow-lg p-6">
    <!-- Upload -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
      <div class="flex-grow">
        <label for="imageUpload" class="block mb-2 text-sm font-medium text-gray-700">Carregar imagem de satélite (.jpg, .png)</label>
        <input type="file" id="imageUpload" accept="image/jpeg, image/png" class="block w-full text-sm text-gray-500
          file:mr-4 file:py-2 file:px-4
          file:rounded-lg file:border-0
          file:text-sm file:font-semibold
          file:bg-blue-50 file:text-blue-700
          hover:file:bg-blue-100 transition-colors duration-200
          cursor-pointer"/>
      </div>
      <button id="analyzeButton" disabled class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2">
        <svg id="analyzeIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        <svg id="loadingSpinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span id="buttonText">Analisar Imagem</span>
      </button>
    </div>

    <!-- Visualização -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-xl font-semibold mb-3 text-center">Imagem Original</h2>
        <div class="canvas-container border-2 border-dashed border-gray-300">
          <div id="originalPlaceholder" class="placeholder-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
          </div>
          <canvas id="originalCanvas"></canvas>
        </div>
      </div>
      <div>
        <h2 class="text-xl font-semibold mb-3 text-center">Análise da I.A.</h2>
        <div class="canvas-container border-2 border-dashed border-gray-300">
          <div id="processedPlaceholder" class="placeholder-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
          </div>
          <canvas id="processedCanvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div id="resultsContainer" class="mt-8">
      <div id="resultsSection" class="bg-gray-50 p-6 rounded-lg shadow-inner hidden">
        <h3 class="text-2xl font-bold text-center mb-4">Resultados da Análise</h3>
        <div class="flex flex-col sm:flex-row justify-around items-center text-center gap-6">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 rounded-full" style="background-color: #10B981;"></div>
            <div>
              <p class="text-sm text-gray-500">Área Florestal</p>
              <p id="forestPercentage" class="text-2xl font-bold text-emerald-600">0%</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 rounded-full" style="background-color: #EF4444;"></div>
            <div>
              <p class="text-sm text-gray-500">Área Desmatada</p>
              <p id="deforestedPercentage" class="text-2xl font-bold text-red-600">0%</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 rounded-full bg-blue-500"></div>
            <div>
              <p class="text-sm text-gray-500">Rios / Outros</p>
              <p id="otherPercentage" class="text-2xl font-bold text-blue-600">0%</p>
            </div>
          </div>
        </div>
      </div>
      <div id="errorSection" class="bg-red-50 text-red-700 p-4 rounded-lg shadow-inner hidden mt-6">
        <h3 class="font-bold text-center">Erro na Análise</h3>
        <p id="errorMessage" class="text-center mt-2"></p>
      </div>
    </div>
  </main>

  <footer class="text-center mt-8 text-sm text-gray-500">
    <p>&copy; 2025 - Projeto de APS. Desenvolvido para fins acadêmicos.</p>
  </footer>
</div>

<script>
  const imageUpload = document.getElementById('imageUpload');
  const analyzeButton = document.getElementById('analyzeButton');
  const originalCanvas = document.getElementById('originalCanvas');
  const processedCanvas = document.getElementById('processedCanvas');
  const originalPlaceholder = document.getElementById('originalPlaceholder');
  const processedPlaceholder = document.getElementById('processedPlaceholder');
  const resultsSection = document.getElementById('resultsSection');
  const errorSection = document.getElementById('errorSection');
  const errorMessage = document.getElementById('errorMessage');
  const forestPercentage = document.getElementById('forestPercentage');
  const deforestedPercentage = document.getElementById('deforestedPercentage');
  const otherPercentage = document.getElementById('otherPercentage');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const analyzeIcon = document.getElementById('analyzeIcon');
  const buttonText = document.getElementById('buttonText');

  const originalCtx = originalCanvas.getContext('2d');
  const processedCtx = processedCanvas.getContext('2d');

  let imageLoaded = false;
  let imageBase64 = null;

  imageUpload.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          originalCanvas.width = img.width;
          originalCanvas.height = img.height;
          processedCanvas.width = img.width;
          processedCanvas.height = img.height;
          originalCtx.drawImage(img, 0, 0);
          imageBase64 = e.target.result;
          originalPlaceholder.classList.add('hidden');
          analyzeButton.disabled = false;
          imageLoaded = true;
          resultsSection.classList.add('hidden');
          errorSection.classList.add('hidden');
          processedPlaceholder.classList.remove('hidden');
          processedCtx.clearRect(0, 0, processedCanvas.width, processedCanvas.height);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  analyzeButton.addEventListener('click', () => {
    if (!imageLoaded || !imageBase64) return;
    analyzeImageWithAPI();
  });

  function setLoadingState(isLoading) {
    if (isLoading) {
      analyzeButton.disabled = true;
      analyzeIcon.classList.add('hidden');
      loadingSpinner.classList.remove('hidden');
      buttonText.textContent = 'Analisando...';
    } else {
      analyzeButton.disabled = false;
      analyzeIcon.classList.remove('hidden');
      loadingSpinner.classList.add('hidden');
      buttonText.textContent = 'Analisar Imagem';
    }
  }

  function showError(message) {
    errorMessage.textContent = message;
    resultsSection.classList.add('hidden');
    errorSection.classList.remove('hidden');
    processedPlaceholder.classList.remove('hidden');
    processedCtx.clearRect(0, 0, processedCanvas.width, processedCanvas.height);
  }

  function generateMaskImage(data) {
    const { forest, deforested, other } = data;
    const totalHeight = processedCanvas.height;
    const totalWidth = processedCanvas.width;

    processedCtx.clearRect(0, 0, totalWidth, totalHeight);
    let currentY = 0;

    const forestHeight = (forest / 100) * totalHeight;
    processedCtx.fillStyle = "#10B981";
    processedCtx.fillRect(0, currentY, totalWidth, forestHeight);
    currentY += forestHeight;

    const deforestedHeight = (deforested / 100) * totalHeight;
    processedCtx.fillStyle = "#EF4444";
    processedCtx.fillRect(0, currentY, totalWidth, deforestedHeight);
    currentY += deforestedHeight;

    const otherHeight = (other / 100) * totalHeight;
    processedCtx.fillStyle = "#3B82F6";
    processedCtx.fillRect(0, currentY, totalWidth, otherHeight);

    processedPlaceholder.classList.add("hidden");
  }

  async function analyzeImageWithAPI() {
    setLoadingState(true);
    resultsSection.classList.add('hidden');
    errorSection.classList.add('hidden');

    const apiKey = "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"; // <-- cole sua chave
    if (!apiKey) {
      showError("Configure sua chave de API primeiro.");
      setLoadingState(false);
      return;
    }

    const apiUrl = "https://api.openai.com/v1/chat/completions";

    try {
      const response = await fetch(apiUrl, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            {
              role: "system",
              content: "Você é um sistema especialista em geociências. Analise imagens de satélite e identifique áreas de floresta, desmatamento e rios/outros."
            },
            {
              role: "user",
              content: [
                { type: "text", text: "Analise esta imagem e retorne SOMENTE um JSON válido no formato {\"forest\": %, \"deforested\": %, \"other\": %}" },
                { type: "image_url", image_url: { url: imageBase64 } }
              ]
            }
          ],
          max_tokens: 300,
          response_format: { "type": "json_object" }  // força saída JSON pura
        })
      });

      const result = await response.json();
      console.log("Resposta OpenAI:", result);

      const analysisData = result.choices?.[0]?.message?.content
        ? JSON.parse(result.choices[0].message.content)
        : null;

      if (!analysisData) throw new Error("Resposta inválida da API");

      forestPercentage.textContent = `${(analysisData.forest || 0).toFixed(2)}%`;
      deforestedPercentage.textContent = `${(analysisData.deforested || 0).toFixed(2)}%`;
      otherPercentage.textContent = `${(analysisData.other || 0).toFixed(2)}%`;

      errorSection.classList.add('hidden');
      resultsSection.classList.remove('hidden');

      generateMaskImage(analysisData);

    } catch (error) {
      console.error("Erro:", error);
      showError(error.message);
    } finally {
      setLoadingState(false);
    }
  }
</script>

</body>
</html>
